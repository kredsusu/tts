<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>F13 Chat – Pop-up</title>

  <style>
    :root { color-scheme: dark; }
    html, body { height:100%; margin:0; background: transparent; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; overflow:hidden; }

    /* A teljes popup UI */
    #wrap{
      height:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:12px;
      box-sizing:border-box;
      opacity: 0.85; /* JS felülírhatja */
    }

    /* Top bar */
    #topbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      padding:10px;
      border-radius:14px;
      background: rgba(10, 12, 16, 0.55);
      border: 1px solid rgba(180,200,255,0.20);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    }
    #left, #right{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    input, button{
      border-radius: 12px;
      border: 1px solid rgba(180,200,255,0.22);
      background: rgba(0,0,0,0.25);
      color: rgba(245,248,255,0.95);
      padding: 10px 12px;
      outline: none;
    }
    input{ min-width: 140px; }
    button{ cursor:pointer; }
    .small{ font-size:12px; opacity:.8; color: rgba(245,248,255,0.86); }

    .rangeWrap{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 6px 10px;
      border-radius: 12px;
      border: 1px solid rgba(180,200,255,0.18);
      background: rgba(0,0,0,0.18);
    }
    .rangeWrap input[type="range"]{ width: 140px; }

    /* Log panel */
    #panel{
      flex:1;
      min-height: 220px;
      border-radius: 14px;
      padding: 10px 10px 8px;
      background: rgba(10, 12, 16, 0.35);
      border: 1px solid rgba(180, 200, 255, 0.18);
      backdrop-filter: blur(6px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      overflow:hidden;
    }
    #log{
      height:100%;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .msg{
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(15, 18, 24, 0.35);
      border: 1px solid rgba(180, 200, 255, 0.10);
      color: rgba(245, 248, 255, 0.92);
      text-shadow: 0 1px 2px rgba(0,0,0,0.35);
    }
    .meta{ font-size:12px; opacity:.78; margin-bottom:3px; }
    .text{ font-size:14px; line-height:1.25; word-wrap:break-word; }

    /* Input bar */
    #inputWrap{
      display:flex;
      gap:10px;
      align-items:center;
      background: rgba(10, 12, 16, 0.50);
      border: 1px solid rgba(180, 200, 255, 0.22);
      border-radius: 14px;
      padding: 10px;
      backdrop-filter: blur(8px);
    }
    #text{ flex:1; min-width: 120px; }
  </style>
</head>

<body>
  <div id="wrap">
    <div id="topbar">
      <div id="left">
        <input id="room" placeholder="Szoba" />
        <input id="name" placeholder="Név" />
        <button id="connect">Csatlakozás</button>
        <span class="small" id="status">Nincs csatlakozva</span>
      </div>
      <div id="right">
        <div class="rangeWrap" title="Áttetszőség">
          <span class="small">Áttetszőség</span>
          <input id="opacityRange" type="range" min="0.2" max="1" step="0.05" value="0.85">
          <span class="small" id="opVal">85%</span>
        </div>
        <button id="ttsToggle" title="Ctrl+M">TTS: OFF</button>
      </div>
    </div>

    <div id="panel">
      <div id="log"></div>
    </div>

    <div id="inputWrap">
      <input id="text" placeholder="Írj... (Enter küld)" autocomplete="off" />
      <button id="send">Küld</button>
    </div>

    <div class="small">
      Hotkeys: <b>Enter</b>=küld • <b>Ctrl+M</b>=TTS • <b>Alt+↑/↓</b>=áttetszőség
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    // --- Firebase config (a tiéd) ---
    const firebaseConfig = {
      apiKey: "AIzaSyB7hcpdkq6AfiCB-53bXRlx6YaB-40bc-U",
      authDomain: "text-b6f9b.firebaseapp.com",
      databaseURL: "https://text-b6f9b-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "text-b6f9b",
      storageBucket: "text-b6f9b.appspot.com",
      messagingSenderId: "736236726211",
      appId: "1:736236726211:web:c73aa0b1a764038e5fff76"
    };

    const LS_KEY = "f13_popup_prefs_v1";

    const $ = (id) => document.getElementById(id);

    const wrap = $("wrap");
    const roomIn = $("room");
    const nameIn = $("name");
    const connectBtn = $("connect");
    const statusEl = $("status");

    const opacityRange = $("opacityRange");
    const opVal = $("opVal");

    const ttsBtn = $("ttsToggle");

    const log = $("log");
    const textIn = $("text");
    const sendBtn = $("send");

    function loadPrefs(){
      try { return JSON.parse(localStorage.getItem(LS_KEY) || "{}"); } catch { return {}; }
    }
    function savePrefs(p){
      try { localStorage.setItem(LS_KEY, JSON.stringify(p)); } catch {}
    }

    // betöltjük a szoba+név értékeket az indexből
    const prefs = loadPrefs();
    if (prefs.room) roomIn.value = prefs.room;
    if (prefs.name) nameIn.value = prefs.name;

    // áttetszőség
    let opacity = typeof prefs.opacity === "number" ? prefs.opacity : 0.85;
    wrap.style.opacity = String(opacity);
    opacityRange.value = String(opacity);
    opVal.textContent = `${Math.round(opacity * 100)}%`;

    function setOpacity(val){
      const v = Math.max(0.2, Math.min(1, parseFloat(val)));
      opacity = v;
      wrap.style.opacity = String(v);
      opacityRange.value = String(v);
      opVal.textContent = `${Math.round(v * 100)}%`;
      savePrefs({ ...loadPrefs(), opacity: v });
    }
    opacityRange.addEventListener("input", () => setOpacity(opacityRange.value));

    // Firebase init
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let roomRef = null;
    let myName = "Player";
    let roomName = "";
    let ttsEnabled = false;
    let firstBatch = true;

    // TTS
    function pickHungarianVoice() {
      const voices = window.speechSynthesis?.getVoices?.() || [];
      return voices.find(v => (v.lang || "").toLowerCase().startsWith("hu")) || null;
    }

    function speakHungarian(text) {
      if (!ttsEnabled) return;
      if (!("speechSynthesis" in window)) return;

      window.speechSynthesis.cancel();

      const u = new SpeechSynthesisUtterance(text);
      u.lang = "hu-HU";
      const v = pickHungarianVoice();
      if (v) u.voice = v;

      window.speechSynthesis.speak(u);
    }

    function escapeHtml(s) {
      return (s ?? "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[c]));
    }

    const MAX_MSG = 14;
    function addMsg({ name, text, ts }) {
      const d = document.createElement("div");
      d.className = "msg";
      const when = ts ? new Date(ts).toLocaleTimeString() : "";
      d.innerHTML = `
        <div class="meta">${escapeHtml(name)} • ${when}</div>
        <div class="text">${escapeHtml(text)}</div>
      `;
      log.appendChild(d);

      while (log.children.length > MAX_MSG) log.removeChild(log.firstChild);
    }

    function setStatus(s){ statusEl.textContent = s; }

    function connect() {
      roomName = roomIn.value.trim();
      myName = (nameIn.value.trim() || "Player").slice(0, 24);

      if (!roomName) return alert("Adj meg szoba nevet!");

      savePrefs({ ...loadPrefs(), room: roomName, name: myName });

      log.innerHTML = "";
      roomRef = ref(db, `rooms/${roomName}/messages`);

      const q = query(roomRef, limitToLast(50));
      firstBatch = true;

      onChildAdded(q, (snap) => {
        const msg = snap.val() || {};
        addMsg({ name: msg.name || "?", text: msg.text || "", ts: msg.ts || Date.now() });

        if (!firstBatch && msg?.name && msg?.text && msg.name !== myName) {
          speakHungarian(`${msg.name} azt írja: ${msg.text}`);
        }
      });

      setStatus(`Csatlakozva: ${roomName}`);
      // 1.2s után már olvas
      setTimeout(() => { firstBatch = false; }, 1200);
      textIn.focus();
    }

    connectBtn.addEventListener("click", connect);

    // Auto-connect ha van szoba a localStorage-ban
    if (prefs.room) {
      // csak akkor auto, ha az ablak valóban megnyílt
      // (és a user nem üres room-mal hagyta)
      setTimeout(() => {
        if (roomIn.value.trim()) connect();
      }, 50);
    }

    // Send
    function send() {
      const text = textIn.value.trim();
      if (!text || !roomRef) return;
      textIn.value = "";
      push(roomRef, { name: myName, text, ts: Date.now() });
    }

    sendBtn.addEventListener("click", send);
    textIn.addEventListener("keydown", (e) => {
      if (e.key === "Enter") send();
    });

    // Hotkeys (popup ablakban működik, ha az aktív)
    window.addEventListener("keydown", (e) => {
      // Ctrl+M: TTS toggle
      if (e.ctrlKey && (e.key === "m" || e.key === "M")) {
        e.preventDefault();
        ttsEnabled = !ttsEnabled;
        ttsBtn.textContent = `TTS: ${ttsEnabled ? "ON" : "OFF"}`;
        if (ttsEnabled) speakHungarian("Magyar hangfelolvasás bekapcsolva.");
        return;
      }

      // Alt+Up/Down: opacity
      if (e.altKey && (e.key === "ArrowUp" || e.key === "ArrowDown")) {
        e.preventDefault();
        const delta = (e.key === "ArrowUp") ? 0.05 : -0.05;
        setOpacity(opacity + delta);
        return;
      }
    });

    // Button toggle TTS
    ttsBtn.addEventListener("click", () => {
      ttsEnabled = !ttsEnabled;
      ttsBtn.textContent = `TTS: ${ttsEnabled ? "ON" : "OFF"}`;
      if (ttsEnabled) speakHungarian("Magyar hangfelolvasás bekapcsolva.");
    });
  </script>
</body>
</html>
