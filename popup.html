<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>F13 – Írás (popup)</title>

  <style>
    :root { color-scheme: dark; }
    html, body { height:100%; margin:0; background: transparent; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow: hidden;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding: 10px;
      box-sizing: border-box;
      background: transparent;
    }

    /* Ez gyakorlatilag az eredeti inputWrap + hint */
    #wrap {
      width: min(520px, calc(100vw - 20px));
    }

    #inputWrap {
      display:flex;
      gap:10px;
      background: rgba(10,12,16,0.5);
      border: 1px solid rgba(180,200,255,0.22);
      border-radius: 14px;
      padding: 10px;
      backdrop-filter: blur(8px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    }

    input, button {
      border-radius: 12px;
      border: 1px solid rgba(180,200,255,0.22);
      background: rgba(0,0,0,0.25);
      color: rgba(245,248,255,0.95);
      padding: 10px 12px;
      outline: none;
    }

    input { flex:1; }
    button { cursor:pointer; }

    #hint {
      margin-top: 8px;
      font-size: 12px;
      opacity: .75;
      pointer-events: none;
      color: rgba(245,248,255,0.85);
      text-shadow: 0 1px 2px rgba(0,0,0,0.35);
    }

    #status {
      margin-top: 8px;
      font-size: 12px;
      opacity: .78;
      color: rgba(245,248,255,0.85);
    }
  </style>
</head>

<body>
  <div id="wrap">
    <div id="inputWrap">
      <input id="text" placeholder="Írj..." autocomplete="off" />
      <button id="send">Küld</button>
    </div>
    <div id="hint">Enter: küld • Esc: bezár • T: fókusz (fő ablakból)</div>
    <div id="status">Nincs csatlakozva</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB7hcpdkq6AfiCB-53bXRlx6YaB-40bc-U",
      authDomain: "text-b6f9b.firebaseapp.com",
      databaseURL: "https://text-b6f9b-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "text-b6f9b",
      storageBucket: "text-b6f9b.appspot.com",
      messagingSenderId: "736236726211",
      appId: "1:736236726211:web:c73aa0b1a764038e5fff76"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const LS_KEY = "f13_chat_state_v1";

    const $ = (id) => document.getElementById(id);
    const textIn = $("text");
    const sendBtn = $("send");
    const status = $("status");

    let roomName = "";
    let myName = "";
    let roomRef = null;

    function loadState(){
      try { return JSON.parse(localStorage.getItem(LS_KEY) || "{}"); }
      catch { return {}; }
    }

    function connectFromState(){
      const st = loadState();
      roomName = (st.roomName || "").trim();
      myName = (st.myName || "Player").trim() || "Player";

      if (!roomName) {
        status.textContent = "Nincs csatlakozva (nyisd meg az index.html-t és csatlakozz).";
        roomRef = null;
        return;
      }

      roomRef = ref(db, `rooms/${roomName}/messages`);
      status.textContent = `Írás: ${roomName} • név: ${myName}`;
    }

    connectFromState();

    function send(){
      if (!roomRef) return;
      const text = textIn.value.trim();
      if (!text) return;
      textIn.value = "";
      push(roomRef, { name: myName, text, ts: Date.now() });
      textIn.focus();
    }

    sendBtn.onclick = send;

    textIn.onkeydown = (e) => {
      if (e.key === "Enter") send();
      if (e.key === "Escape") window.close();
    };

    // fókusz kérés a fő ablakból
    window.addEventListener("message", (ev) => {
      if (ev?.data?.type === "focusInput") {
        textIn.focus();
        textIn.select();
      }
    });

    // ha a room/name később frissül (pl. csatlakozás után nyitod meg), újra olvassuk
    window.addEventListener("focus", () => connectFromState());

    // induláskor fókusz
    setTimeout(() => { textIn.focus(); }, 50);
  </script>
</body>
</html>
