<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>F13 HUD Chat</title>

  <style>
    :root { color-scheme: dark; }
    html, body { height:100%; margin:0; background: transparent; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow: hidden;
    }

    /* HUD */
    #hud {
      position: fixed;
      left: 18px;
      bottom: 18px;
      width: min(520px, calc(100vw - 36px));
      pointer-events: none;
      user-select: none;
    }

    #panel {
      pointer-events: none;
      border-radius: 14px;
      padding: 10px;
      background: rgba(10,12,16,0.35);
      border: 1px solid rgba(180,200,255,0.18);
      backdrop-filter: blur(6px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    }

    #log {
      height: 220px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow: hidden;
    }

    .msg {
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(15,18,24,0.35);
      border: 1px solid rgba(180,200,255,0.10);
      color: rgba(245,248,255,0.92);
      text-shadow: 0 1px 2px rgba(0,0,0,0.35);
    }

    .meta { font-size: 12px; opacity: .78; margin-bottom: 3px; }
    .text { font-size: 14px; line-height: 1.25; }

    #setup {
      position: fixed;
      top: 14px;
      left: 14px;
      width: min(640px, calc(100vw - 28px));
      border-radius: 14px;
      padding: 12px;
      background: rgba(10,12,16,0.55);
      border: 1px solid rgba(180,200,255,0.20);
      backdrop-filter: blur(10px);
      color: rgba(245,248,255,0.92);
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      pointer-events: auto;
      user-select: auto;
    }

    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .hidden { display:none !important; }
    #status { font-size: 12px; opacity: .82; margin-top: 8px; }

    input, button {
      border-radius: 12px;
      border: 1px solid rgba(180,200,255,0.22);
      background: rgba(0,0,0,0.25);
      color: rgba(245,248,255,0.95);
      padding: 10px 12px;
      outline: none;
    }
    input { flex:1; min-width: 160px; }
    button { cursor:pointer; }
  </style>
</head>

<body>

  <!-- Setup -->
  <div id="setup">
    <div class="row">
      <input id="room" placeholder="Szoba (pl. f13-private)" />
      <input id="name" placeholder="Neved" />
      <button id="join">Csatlakozás</button>
      <button id="openPopup" disabled>Írás megnyitása (popup)</button>
      <button id="ttsToggle" disabled>TTS: OFF</button>
    </div>
    <div id="status">Állapot: nincs csatlakozva</div>
    <div style="margin-top:6px;font-size:12px;opacity:.75">
      Hotkeys (fő ablak): T = popup fókusz • Ctrl+M = TTS
    </div>
    <div style="margin-top:6px;font-size:12px;opacity:.75">
      Tipp: elsőre kattints az „Írás megnyitása (popup)” gombra (a böngésző csak kattintásra enged új ablakot).
    </div>
  </div>

  <!-- HUD -->
  <div id="hud" class="hidden">
    <div id="panel">
      <div id="log"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB7hcpdkq6AfiCB-53bXRlx6YaB-40bc-U",
      authDomain: "text-b6f9b.firebaseapp.com",
      databaseURL: "https://text-b6f9b-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "text-b6f9b",
      storageBucket: "text-b6f9b.appspot.com",
      messagingSenderId: "736236726211",
      appId: "1:736236726211:web:c73aa0b1a764038e5fff76"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const $ = id => document.getElementById(id);

    const setup = $("setup");
    const hud = $("hud");
    const log = $("log");
    const status = know("status");

    function know(id){ return document.getElementById(id); }

    const roomIn = $("room");
    const nameIn = $("name");
    const joinBtn = $("join");
    const openPopupBtn = $("openPopup");
    const ttsBtn = $("ttsToggle");

    let roomRef = null;
    let myName = "";
    let roomName = "";
    let ttsEnabled = false;

    // Popup window handle
    let popupWin = null;

    // Shared state key (popup innen olvassa)
    const LS_KEY = "f13_chat_state_v1";

    function speak(text) {
      if (!ttsEnabled || !("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "hu-HU";
      window.speechSynthesis.speak(u);
    }

    function esc(s){
      return (s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[c]));
    }

    function addMsg(name, text, ts) {
      const d = document.createElement("div");
      d.className = "msg";
      d.innerHTML =
        `<div class="meta">${esc(name)} • ${new Date(ts).toLocaleTimeString()}</div>` +
        `<div class="text">${esc(text)}</div>`;
      log.appendChild(d);
      while (log.children.length > 10) log.removeChild(log.firstChild);
    }

    function setConnected(on) {
      ttsBtn.disabled = !on;
      openPopupBtn.disabled = !on;
      if (on) {
        setup.classList.add("hidden");
        hud.classList.remove("hidden");
      }
    }

    function saveState() {
      localStorage.setItem(LS_KEY, JSON.stringify({
        roomName,
        myName
      }));
    }

    joinBtn.onclick = () => {
      roomName = roomIn.value.trim();
      myName = nameIn.value.trim() || "Player";
      if (!roomName) return alert("Adj meg szoba nevet!");

      saveState();

      log.innerHTML = "";
      roomRef = ref(db, `rooms/${roomName}/messages`);
      const q = query(roomRef, limitToLast(50));
      let ready = false;

      onChildAdded(q, snap => {
        const m = snap.val();
        addMsg(m.name, m.text, m.ts);
        if (ready && m.name !== myName) speak(`${m.name} azt írja: ${m.text}`);
      });

      setTimeout(() => ready = true, 1200);

      status.textContent = `Csatlakozva: ${roomName}`;
      setConnected(true);
    };

    // Open popup (only on click)
    openPopupBtn.onclick = () => {
      if (!roomName) return alert("Előbb csatlakozz!");
      saveState();

      const w = window.open(
        "popup.html",
        "F13InputPopup",
        "width=560,height=170,resizable=yes,scrollbars=no"
      );

      if (!w) return alert("A böngésző blokkolta a pop-upot. Engedélyezd a felugró ablakokat ehhez az oldalhoz.");

      popupWin = w;

      // kis késleltetés után fókusz kérés (nem gond, ha nem sikerül azonnal)
      setTimeout(() => {
        try {
          popupWin.focus();
          popupWin.postMessage({ type: "focusInput" }, "*");
        } catch {}
      }, 200);
    };

    // TTS toggle
    ttsBtn.onclick = () => {
      ttsEnabled = !ttsEnabled;
      ttsBtn.textContent = `TTS: ${ttsEnabled ? "ON" : "OFF"}`;
      if (ttsEnabled) speak("Magyar hangfelolvasás bekapcsolva.");
    };

    // Hotkey: T -> ha a popup nyitva van, fókusz és input fókusz
    window.addEventListener("keydown", e => {
      if (e.ctrlKey && (e.key === "m" || e.key === "M")) {
        ttsEnabled = !ttsEnabled;
        ttsBtn.textContent = `TTS: ${ttsEnabled ? "ON" : "OFF"}`;
        if (ttsEnabled) speak("Magyar hangfelolvasás bekapcsolva.");
      }

      if (e.key.toLowerCase() === "t") {
        if (popupWin && !popupWin.closed) {
          try {
            popupWin.focus();
            popupWin.postMessage({ type: "focusInput" }, "*");
          } catch {}
        }
      }
    });

    setConnected(false);
  </script>
</body>
</html>
