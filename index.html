<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>F13 HUD Chat</title>

  <style>
    :root { color-scheme: dark; }
    html, body { height:100%; margin:0; background: transparent; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; overflow:hidden; }

    /* HUD container */
    #hud{
      position: fixed;
      left: 18px;
      bottom: 18px;
      width: min(520px, calc(100vw - 36px));
      pointer-events: none; /* overlay mód: átklikkelhető */
      user-select: none;
      opacity: 0.75;        /* JS felülírhatja */
    }
    /* interaktív mód (F8): kattintható + PowerToys-hoz */
    #hud.interactive{
      pointer-events: auto;
      user-select: auto;
    }

    /* Mini bar */
    #miniBar{
      display:flex;
      gap:8px;
      margin-bottom:8px;
      pointer-events:auto;
      user-select:none;
    }
    #miniBar button{
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(180,200,255,0.22);
      background: rgba(0,0,0,0.20);
      color: rgba(245,248,255,0.95);
      cursor:pointer;
    }
    #miniBar .pill{
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(180,200,255,0.14);
      background: rgba(0,0,0,0.14);
      color: rgba(245,248,255,0.85);
      font-size: 12px;
      display:flex;
      align-items:center;
      pointer-events:none;
      white-space: nowrap;
    }

    /* Panel */
    #panel{
      pointer-events:none;
      border-radius: 14px;
      padding: 10px 10px 8px;
      background: rgba(10, 12, 16, 0.35);
      border: 1px solid rgba(180, 200, 255, 0.18);
      backdrop-filter: blur(6px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    }
    #log{
      height: 220px;
      overflow: hidden;
      display:flex;
      flex-direction: column;
      gap: 8px;
    }
    .msg{
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(15, 18, 24, 0.35);
      border: 1px solid rgba(180, 200, 255, 0.10);
      color: rgba(245, 248, 255, 0.92);
      text-shadow: 0 1px 2px rgba(0,0,0,0.35);
    }
    .meta{ font-size: 12px; opacity: .78; margin-bottom: 3px; }
    .text{ font-size: 14px; line-height: 1.25; word-wrap: break-word; }

    /* Popup/collapse állapotok */
    #panel.hiddenPanel{ display:none; }
    #panel.collapsedPanel #log{ display:none; }
    #panel.collapsedPanel{ padding: 8px 10px; }

    /* Input bar */
    #inputBar{
      margin-top: 10px;
      display:none;
      pointer-events:auto;
      user-select:auto;
    }
    #inputWrap{
      display:flex;
      gap:10px;
      align-items:center;
      background: rgba(10, 12, 16, 0.50);
      border: 1px solid rgba(180, 200, 255, 0.22);
      border-radius: 14px;
      padding: 10px;
      backdrop-filter: blur(8px);
    }
    input, button{
      border-radius: 12px;
      border: 1px solid rgba(180,200,255,0.22);
      background: rgba(0,0,0,0.25);
      color: rgba(245,248,255,0.95);
      padding: 10px 12px;
      outline: none;
    }
    input{ flex:1; min-width: 120px; }
    button{ cursor:pointer; }
    #hint{
      margin-top: 8px;
      font-size: 12px;
      color: rgba(245,248,255,0.75);
      text-shadow: 0 1px 2px rgba(0,0,0,0.35);
      pointer-events:none;
    }

    /* Setup */
    #setup{
      position: fixed;
      top: 14px;
      left: 14px;
      width: min(900px, calc(100vw - 28px));
      border-radius: 14px;
      padding: 12px;
      background: rgba(10, 12, 16, 0.55);
      border: 1px solid rgba(180,200,255,0.20);
      backdrop-filter: blur(10px);
      color: rgba(245,248,255,0.92);
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      pointer-events:auto;
      user-select:auto;
    }
    #setup .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    #setup input{ flex:1; min-width: 160px; }

    .small{ font-size: 12px; opacity: .78; }
    #status{ margin-top: 8px; font-size: 12px; opacity: 0.82; }
    .hidden{ display:none !important; }

    .rangeWrap{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 6px 10px;
      border-radius: 12px;
      border: 1px solid rgba(180,200,255,0.18);
      background: rgba(0,0,0,0.18);
    }
    .rangeWrap input[type="range"]{ width: 180px; }

    code.kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      opacity:.9;
      padding:2px 6px;
      border-radius:8px;
      border:1px solid rgba(180,200,255,0.18);
      background: rgba(0,0,0,0.18);
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <!-- Setup -->
  <div id="setup">
    <div class="row">
      <input id="room" placeholder="Szoba (pl. f13-private)" />
      <input id="name" placeholder="Neved (pl. Dani)" />

      <div class="rangeWrap" title="HUD áttetszőség">
        <span class="small">Áttetszőség</span>
        <input id="opacityRange" type="range" min="0.2" max="1" step="0.05" value="0.75">
        <span class="small" id="opVal">75%</span>
      </div>

      <button id="join">Csatlakozás</button>
      <button id="ttsToggle" title="Ctrl+M" disabled>TTS: OFF</button>
    </div>

    <div id="status">Állapot: nincs csatlakozva</div>
    <div class="small" style="margin-top:6px;">
      Hotkeys:
      <code class="kbd">T</code>=írni • <code class="kbd">Enter</code>=küld • <code class="kbd">Esc</code>=bezár írásból •
      <code class="kbd">Ctrl+M</code>=TTS • <code class="kbd">C</code>=chat fel/le • <code class="kbd">L</code>=üzenetek fel/le •
      <code class="kbd">F8</code>=Overlay/Szerkesztés mód • <code class="kbd">Alt+↑/↓</code>=áttetszőség
    </div>
  </div>

  <!-- HUD -->
  <div id="hud" class="hidden">
    <div id="miniBar">
      <button id="toggleChat" title="Chat fel/le (C)">Chat</button>
      <button id="toggleLog" title="Üzenetek fel/le (L)">Üzenetek</button>
      <div class="pill" id="modePill">Overlay mód (F8)</div>
    </div>

    <div id="panel">
      <div id="log"></div>
    </div>

    <div id="inputBar">
      <div id="inputWrap">
        <input id="text" placeholder="Írj... (Enter küld, Esc bezár)" autocomplete="off" />
        <button id="send">Küld</button>
      </div>
      <div id="hint">T: írni • Ctrl+M: TTS • C/L: fel-le • F8: kattintható mód</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    // --- Firebase config (a tiéd) ---
    const firebaseConfig = {
      apiKey: "AIzaSyB7hcpdkq6AfiCB-53bXRlx6YaB-40bc-U",
      authDomain: "text-b6f9b.firebaseapp.com",
      databaseURL: "https://text-b6f9b-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "text-b6f9b",
      storageBucket: "text-b6f9b.appspot.com",
      messagingSenderId: "736236726211",
      appId: "1:736236726211:web:c73aa0b1a764038e5fff76"
    };

    const $ = (id) => document.getElementById(id);

    // Setup
    const setup = $("setup");
    const status = $("status");
    const roomIn = $("room");
    const nameIn = $("name");
    const opacityRange = $("opacityRange");
    const opVal = $("opVal");
    const joinBtn = $("join");
    const ttsBtn = $("ttsToggle");

    // HUD
    const hud = $("hud");
    const panel = $("panel");
    const log = $("log");
    const inputBar = $("inputBar");
    const textIn = $("text");
    const sendBtn = $("send");
    const toggleChatBtn = $("toggleChat");
    const toggleLogBtn  = $("toggleLog");
    const modePill = $("modePill");

    // Preferences
    const LS_KEY = "f13_hud_chat_clean_v1";
    function loadPrefs() {
      try { return JSON.parse(localStorage.getItem(LS_KEY) || "{}"); } catch { return {}; }
    }
    function savePrefs(p) {
      try { localStorage.setItem(LS_KEY, JSON.stringify(p)); } catch {}
    }
    const prefs = loadPrefs();

    // HUD states
    let chatVisible = (prefs.chatVisible ?? true);
    let logCollapsed = !!prefs.logCollapsed;

    function applyUIState() {
      panel.classList.toggle("hiddenPanel", !chatVisible);
      panel.classList.toggle("collapsedPanel", logCollapsed);
      toggleChatBtn.textContent = chatVisible ? "Chat" : "Chat (zárva)";
      toggleLogBtn.textContent = logCollapsed ? "Üzenetek (zárva)" : "Üzenetek";
    }

    toggleChatBtn.addEventListener("click", () => {
      chatVisible = !chatVisible;
      savePrefs({ ...loadPrefs(), chatVisible });
      applyUIState();
    });

    toggleLogBtn.addEventListener("click", () => {
      logCollapsed = !logCollapsed;
      savePrefs({ ...loadPrefs(), logCollapsed });
      applyUIState();
    });

    // Opacity
    let hudOpacity = typeof prefs.opacity === "number" ? prefs.opacity : 0.75;
    hud.style.opacity = String(hudOpacity);
    opacityRange.value = String(hudOpacity);
    opVal.textContent = `${Math.round(hudOpacity * 100)}%`;

    function setOpacity(val) {
      const v = Math.max(0.2, Math.min(1, parseFloat(val)));
      hudOpacity = v;
      hud.style.opacity = String(v);
      opVal.textContent = `${Math.round(v * 100)}%`;
      savePrefs({ ...loadPrefs(), opacity: v });
    }
    opacityRange.addEventListener("input", () => setOpacity(opacityRange.value));

    // Overlay vs interactive mode (F8)
    let hudInteractive = !!prefs.hudInteractive;
    hud.classList.toggle("interactive", hudInteractive);

    function updateModePill() {
      modePill.textContent = hudInteractive ? "Szerkesztés mód (F8) – kattintható" : "Overlay mód (F8) – átklikkelhető";
    }
    updateModePill();

    function toggleInteractive() {
      hudInteractive = !hudInteractive;
      hud.classList.toggle("interactive", hudInteractive);
      savePrefs({ ...loadPrefs(), hudInteractive });
      updateModePill();
    }

    // Firebase init
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let roomRef = null;
    let myName = "Player";
    let roomName = "";
    let ttsEnabled = false;

    // TTS (egyszerű, magyar)
    function pickHungarianVoice() {
      const voices = window.speechSynthesis?.getVoices?.() || [];
      return voices.find(v => (v.lang || "").toLowerCase().startsWith("hu")) || null;
    }

    function speakHungarian(text) {
      if (!ttsEnabled) return;
      if (!("speechSynthesis" in window)) return;

      // stabilabb: ne csússzon össze, legyen “tiszta” felolvasás
      window.speechSynthesis.cancel();

      const u = new SpeechSynthesisUtterance(text);
      u.lang = "hu-HU";
      const v = pickHungarianVoice();
      if (v) u.voice = v;
      window.speechSynthesis.speak(u);
    }

    // Utils
    function escapeHtml(s) {
      return (s ?? "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[c]));
    }

    const MAX_MSG = 10;
    function addMsg({ name, text, ts }) {
      const d = document.createElement("div");
      d.className = "msg";
      const when = ts ? new Date(ts).toLocaleTimeString() : "";
      d.innerHTML = `
        <div class="meta">${escapeHtml(name)} • ${when}</div>
        <div class="text">${escapeHtml(text)}</div>
      `;
      log.appendChild(d);
      while (log.children.length > MAX_MSG) log.removeChild(log.firstChild);
    }

    function setConnected(on) {
      ttsBtn.disabled = !on;
      if (on) {
        status.textContent = `Állapot: csatlakozva • szoba: ${roomName}`;
        setup.classList.add("hidden");
        hud.classList.remove("hidden");
        applyUIState();
        updateModePill();
      } else {
        status.textContent = "Állapot: nincs csatlakozva";
      }
    }

    // Join
    joinBtn.addEventListener("click", () => {
      roomName = roomIn.value.trim();
      myName = (nameIn.value.trim() || "Player").slice(0, 24);
      if (!roomName) return alert("Adj meg szoba nevet!");

      savePrefs({
        ...loadPrefs(),
        opacity: hudOpacity,
        chatVisible,
        logCollapsed,
        hudInteractive
      });

      log.innerHTML = "";
      roomRef = ref(db, `rooms/${roomName}/messages`);

      const q = query(roomRef, limitToLast(50));
      let firstBatch = true;

      onChildAdded(q, (snap) => {
        const msg = snap.val() || {};
        addMsg({ name: msg.name || "?", text: msg.text || "", ts: msg.ts || Date.now() });

        // Auto-popup: ha chat el volt rejtve, 3 mp-re felnyitjuk új üzenetnél
        if (!firstBatch && !chatVisible) {
          chatVisible = true;
          applyUIState();
          setTimeout(() => {
            chatVisible = false;
            applyUIState();
          }, 3000);
        }

        // TTS: csak másoktól
        if (!firstBatch && msg?.name && msg?.text && msg.name !== myName) {
          speakHungarian(`${msg.name} azt írja: ${msg.text}`);
        }
      });

      setConnected(true);
      setTimeout(() => { firstBatch = false; }, 1200);
    });

    // Send
    function send() {
      const text = textIn.value.trim();
      if (!text || !roomRef) return;
      textIn.value = "";
      push(roomRef, { name: myName, text, ts: Date.now() });
    }
    sendBtn.addEventListener("click", send);
    textIn.addEventListener("keydown", (e) => {
      if (e.key === "Enter") send();
      if (e.key === "Escape") hideInput();
    });

    // Input show/hide
    function showInput() {
      inputBar.style.display = "block";
      textIn.focus();
      textIn.select();
    }
    function hideInput() {
      inputBar.style.display = "none";
      textIn.blur();
    }

    // Hotkeys
    window.addEventListener("keydown", (e) => {
      // Ctrl+M: TTS toggle
      if (e.ctrlKey && (e.key === "m" || e.key === "M")) {
        e.preventDefault();
        toggleTTS();
        return;
      }

      // Alt+Up/Down: opacity
      if (e.altKey && (e.key === "ArrowUp" || e.key === "ArrowDown")) {
        e.preventDefault();
        const delta = (e.key === "ArrowUp") ? 0.05 : -0.05;
        setOpacity(hudOpacity + delta);
        opacityRange.value = String(hudOpacity);
        return;
      }

      // F8: interactive toggle (PowerToys kijelöléshez)
      if (e.key === "F8") {
        e.preventDefault();
        toggleInteractive();
        return;
      }

      // Ne zavarjuk gépelés közben
      const activeTag = document.activeElement?.tagName?.toLowerCase();
      const typingInField = activeTag === "input" || activeTag === "textarea";
      if (typingInField) return;

      // C: chat panel fel/le
      if (e.key === "c" || e.key === "C") {
        chatVisible = !chatVisible;
        savePrefs({ ...loadPrefs(), chatVisible });
        applyUIState();
        return;
      }

      // L: log fel/le
      if (e.key === "l" || e.key === "L") {
        logCollapsed = !logCollapsed;
        savePrefs({ ...loadPrefs(), logCollapsed });
        applyUIState();
        return;
      }

      // T: írni
      if (e.key === "t" || e.key === "T") {
        e.preventDefault();
        showInput();
        return;
      }

      // Esc: input bezár
      if (e.key === "Escape") hideInput();
    });

    // TTS toggle
    function toggleTTS() {
      ttsEnabled = !ttsEnabled;
      ttsBtn.textContent = `TTS: ${ttsEnabled ? "ON" : "OFF"}`;
      if (ttsEnabled) speakHungarian("Magyar hangfelolvasás bekapcsolva.");
    }
    ttsBtn.addEventListener("click", toggleTTS);

    // Start
    setConnected(false);
  </script>
</body>
</html>
